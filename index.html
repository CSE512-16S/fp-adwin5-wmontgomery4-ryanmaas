<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8">
<title>Learning Hierarchies of Concepts</title>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.2/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>

<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="//d3js.org/d3.v3.min.js"></script>

<!-- Link Swiper's CSS -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/Swiper/3.0.1/css/swiper.min.css">

<!-- Demo styles -->
<style>

body {
    background: #fff;
    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
    font-size: 14px;
    color:#000;
    margin: 0;
    padding: 0;
}
.swiper-container {
    width: 100%;
    height: 500px;
    margin: 20px auto;
}
.swiper-slide {
    text-align: center;
    font-size: 18px;
    background:  #f9f9f9;
    width: 500px;
    /* Center slide text vertically */
    display: -webkit-box;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    -webkit-justify-content: center;
    justify-content: center;
    -webkit-box-align: center;
    -ms-flex-align: center;
    -webkit-align-items: center;
    align-items: center;
}
svg {
    border: solid 1px #ccc;
    font: 10px sans-serif;
}
.link {
    fill: none;
    stroke: #ccc;
    stroke-width: 1.5px;
}

.svg-container {
    display: inline-block;
    position: relative;
    width: 100%;
    padding-bottom: 100%; /* aspect ratio */
    vertical-align: top;
    overflow: hidden;
}
.svg-content-responsive {
    display: inline-block;
    position: absolute;
    top: 10px;
    left: 0;
}
.arrange-vertically > * {
    display: block;
}
.row {
  width: 100%;
}
.block {
  width: 560px; padding: 10px;
  position:relative;
  display: inline-block; // display inline with abality to provide width/height
}
.bold {
    font-weight : bold;
}

</style>
</head>

<body>
<div class="container">
    <div class="row">
        <div class="jumbotron">
            <h1>Interactive Learning for Hierarchy of Concepts</h1>
            <p>Answering the question, our system forms the hierarchy of concepts steps by steps. In every iteration, the system will throw the most informative question based on current hierarchy.</p>
            <p><a class="btn btn-primary btn-lg" role="button" id="startBTN">Let's build the tree Â»</a>
            </p>
        </div>
    </div>

    <div class="arrange-vertically">
        <!-- Question box -->
        <div class="row log well col-md-12" id="vizSection">
            <h2 id="questionTitle">Question Goes Here</h2>
            <button id="answerYES" type="submit" class="btn btn-default btn-md">Yes</button>
            <button id="answerNO" type="submit" class="btn btn-default btn-md">No</button>
            <button id="next_question"type="submit" class="btn btn-default btn-md">Next</button>
            <button id="restartBTN" type="submit" class="btn btn-default btn-md">Restart</button>
            <button id="animationBTN"type="button" class="btn btn-success pull-right btn-md">Animation</button>
            <button id="galleryBTN"type="submit" class="btn btn-info pull-right btn-md">Gallery</button>
            <p><div id="slidesProgress" class="progress progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:0%"> 1% </div></p>
        </div>

        <!-- Display the current trees -->
        <div class="row" id="viz">
            <div class="block" id="chart1"></div>
            <div class="block" id="chart2"></div>
        </div>

        <!-- Swiper -->

        <!-- Gallery Section -->
        <div class="row log" id="gallerySection">
            <div class="well col-md-12">
                <h2 id="galleryTITLE">Gallery Slides</h2>
                <button id="galleryBTNBack"type="submit" class="btn btn-info pull-right btn-lg">Back</button>
            </div>
        </div>

        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="swiper-slide" id="s0">Slide 0</div>
                <div class="swiper-slide" id="s1">Slide 1</div>
                <div class="swiper-slide" id="s2">Slide 2</div>
                <div class="swiper-slide" id="s3">Slide 3</div>
                <div class="swiper-slide" id="s4">Slide 4</div>
                <div class="swiper-slide" id="s5">Slide 5</div>
                <div class="swiper-slide" id="s6">Slide 6</div>
                <div class="swiper-slide" id="s7">Slide 7</div>
                <div class="swiper-slide" id="s8">Slide 8</div>
                <div class="swiper-slide" id="s9">Slide 9</div>
                <div class="swiper-slide" id="s10">Slide 10</div>
                <div class="swiper-slide" id="s11">Slide 11</div>
                <div class="swiper-slide" id="s12">Slide 12</div>
                <div class="swiper-slide" id="s13">Slide 13</div>
                <div class="swiper-slide" id="s14">Slide 14</div>
                <div class="swiper-slide" id="s15">Slide 15</div>
                <div class="swiper-slide" id="s16">Slide 16</div>
                <div class="swiper-slide" id="s17">Slide 17</div>
                <div class="swiper-slide" id="s18">Slide 18</div>
                <div class="swiper-slide" id="s19">Slide 19</div>
                <div class="swiper-slide" id="s20">Slide 20</div>
                <div class="swiper-slide" id="s21">Slide 21</div>
                <div class="swiper-slide" id="s22">Slide 22</div>
                <div class="swiper-slide" id="s23">Slide 23</div>
                <div class="swiper-slide" id="s24">Slide 24</div>
                <div class="swiper-slide" id="s25">Slide 25</div>
                <div class="swiper-slide" id="s26">Slide 26</div>
                <div class="swiper-slide" id="s27">Slide 27</div>
                <div class="swiper-slide" id="s28">Slide 28</div>
                <div class="swiper-slide" id="s29">Slide 29</div>
                <div class="swiper-slide" id="s30">Slide 30</div>
                <div class="swiper-slide" id="s31">Slide 31</div>
                <div class="swiper-slide" id="s32">Slide 32</div>
            </div>
            <!-- Add Scrollbar -->
            <div class="swiper-scrollbar"></div>
        </div>

        <!-- <animation> -->
        <!-- <title>    -->
        <div class="row log" id="animationSection">
            <div class="well col-md-12">
                <h2 id="galleryTITLE">Video animation</h2>
                <button id="animationBTNBack"type="submit" class="btn btn-info pull-right btn-lg">Back</button>
            </div>
        </div>

        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="swiper-slide" id="s0">Slide 1</div>
                <div class="swiper-slide" id="s1">Slide 2</div>
                <div class="swiper-slide" id="s2">Slide 3</div>
                <div class="swiper-slide" id="s3">Slide 4</div>
                <div class="swiper-slide" id="s4">Slide 5</div>
                <div class="swiper-slide" id="s5">Slide 6</div>
                <div class="swiper-slide" id="s6">Slide 7</div>
                <div class="swiper-slide" id="s7">Slide 8</div>
                <div class="swiper-slide" id="s8">Slide 9</div>
                <div class="swiper-slide" id="s9">Slide 10</div>
            </div>
            <!--Add Scrollbar-->
            <div class="swiper-scrollbar"></div>
        </div>      
    </div>
</div>    


    <!-- Swiper JS -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/Swiper/3.0.1/js/swiper.min.js"></script>

    <!-- Initialize Swiper -->
    <script>
    var swiper = new Swiper('.swiper-container', {
        scrollbar: '.swiper-scrollbar',
        scrollbarHide: true,
        slidesPerView: 'auto',
        centeredSlides: true,
        spaceBetween: 30,
        grabCursor: true
    });
    </script>
      <!-- Initialize socket communication with server -->
    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
     <!-- Handle socket communication -->
    <script type="text/javascript">
    // This script block handles all the Socket-IO communication
    var handleServerRequest = function(data) {
        console.log({
            source: 'server',
            action: 'request',
            data: data
        });
        dataHistory.push(data.value);//store data in here
        if(seq==0)
            updateINIT(data);
        else
            updateANS(data);
    };

    var socket = io.connect('http://localhost'); //, {port:81}
    socket.on('server request', handleServerRequest);
    // socket.on('update_after_answer', function(data){
    //     console.log('update_after_answer'+data.value);
    // });
    //tell the server to generate new tree, question and matrix based on the yes/no
    function answerButtonClicked() {
        socket.emit(
            "answer_button_clicked",1);// [Yes,no] = [1,0]
        //set answer hidden //set next visible
        document.getElementById("answerYES").style.visibility="hidden";
        document.getElementById("answerNO").style.visibility="hidden";
        document.getElementById("next_question").style.visibility="visible";
    }
    function nextQuestionButtonClicked() {
        //change the layout from right to left//***
        //socket.emit(
        //    "next_question",1);

        //set next hidden //set answer visible
        document.getElementById("answerYES").style.visibility="visible";
        document.getElementById("answerNO").style.visibility="visible";
        document.getElementById("next_question").style.visibility="hidden";
        updateNEXT();

    } 
    function restartButtonClicked() {
        seq=0;
        document.getElementById("answerYES").style.visibility="visible";
        document.getElementById("answerNO").style.visibility="visible";
        document.getElementById("restartBTN").style.visibility="hidden";
        $("#slidesProgress").attr("class", "progress-bar progress-bar-striped active");
        document.getElementById("slidesProgress").style.width= 0+"%";
        $("#slidesProgress").html(0+"%");  
        d3.select('#chart1').select("svg").remove();
        d3.select('#chart2').select("svg").remove();
        socket.emit("restart",1);//send notification to server
        //clear dataHistory
        dataHistory = [];
        //clear the gallery
        for(var i=0;i<33;i++)
        {
            d3.select('#s'+i).selectAll("svg").remove();
        }
        for(var i=1;i<33;i++)
        {
            d3.select('#s'+i).html("slides"+i);
        }        
    } 
    document.getElementById("answerYES").addEventListener("click", answerButtonClicked);
    document.getElementById("answerNO").addEventListener("click", answerButtonClicked); //right now call the same function***
    document.getElementById("next_question").addEventListener("click", nextQuestionButtonClicked);
    document.getElementById("restartBTN").addEventListener("click", restartButtonClicked);
    document.getElementById("restartBTN").style.visibility="hidden";

    </script>

    <!-- Visualization -->
    <script type="text/javascript">
    var dataHistory = []; //array to restore json tree and question
    var seq = 0; // variable indicates current iteration
    var seqTotal = 32; //set the max number of seq
    var questionTEM;

    function createSVG(stage, widthSVG, transSVG, callback){
                vis = d3.select(stage).append("svg:svg")
                    .attr("width", widthSVG)
                    .attr("height", widthSVG)
                    .append("svg:g")
                    .attr("transform", "translate("+transSVG+", "+transSVG+")"); 
                callback(vis);        
    }
    function render(vis,actual_JSON, stage){
                var treeData = actual_JSON.value.tree;
                var question = actual_JSON.value.question;
                var seqKeyword;
                
                // Create a cluster "canvas"
                var cluster = d3.layout.cluster()
                .size([300,150]);
     
                var diagonal = d3.svg.diagonal.radial()
                .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });
                 
                var nodes = cluster.nodes(treeData);
                var links = cluster.links(nodes);
     
                var link = vis.selectAll("pathlink")
                .data(links)
                .enter().append("svg:path")
                .attr("class", "link")
                .attr("d", diagonal)
     
                var node = vis.selectAll("g.node")
                    .data(nodes)
                    .enter().append("svg:g")
                    .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
     
                // Add the dot at every node
                node.append("svg:circle")
                    .attr("r", 3.5);
     
                node.append("svg:text")
                    .attr("dx", function(d) { return d.x < 180 ? 8 : -8; })
                    .attr("dy", ".31em")
                    .attr("fill", 
                        function(d){//highlight the chosen node
                            if(stage == "#chart2")
                                seqKeyword = seq-1;
                            else
                                seqKeyword = seq;
                            if(d.name == question[0]||d.name == question[1].replace(/\s+/g,"")) return "red";
                            else    return "black";
                        })
                    .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
                    .attr("transform", function(d) { return d.x < 180 ? null : "rotate(180)"; })
                    .text(function(d) { return d.name; });
                
            }    
    function updateINIT(data){
            //set next invisible initially
            document.getElementById("next_question").style.visibility="hidden";

            createSVG("#chart1", 560, 280, function(vis){   
                render(vis, data, "#chart1");  
            });
            //plot to the slide
            $('#s0').empty()
            createSVG("#s"+seq, 500, 250, function(vis){
                render(vis, data, "#s0");  
            });    
            //set question title
            $("#questionTitle").html("Q1 : "+'<mark>' + data.value.question[1].replace(/\s+/g,"") + '</mark>' + " is the children of " + '<mark>' + data.value.question[0] + '</mark>' +" ?");
            seq++;
    }
    //called when user click Yes/No, and the system would send the posterior tree as the input of this function "data"        
    function updateANS(data){
        createSVG("#chart2", 560, 280, function(vis){
            //do the transition animation [from the current state to next state]*************************



            //
            render(vis, data, "#chart2");//right now just plot the posterior json tree// the last state tree can be acquired by dataHistory  
        });
        //plot this to slides
        if(seq<33)
        {
            $("#s"+seq).empty()
            createSVG("#s"+seq, 500, 250, function(vis){
                render(vis, data, "#s0");  
            });    
            //plot question on slides
            d3.select("#s"+seq).select("svg").append("text").text("Q"+seq+" : "+data.value.question[1].replace(/\s+/g,"") +" <- "+data.value.question[0]+" ?").attr("x",250).attr("y",20).attr("font-size",25)
                .attr("font-family","serif")
                .attr("text-anchor","middle");    
        }
        //update the question temporal variable 
        questionTEM = data.value.question;    
        if(seq<301) seq++;
    }
    //called when user click next
    function updateNEXT(){
        $("#questionTitle").html("Q"+seq+" : "+'<mark>' + questionTEM[1].replace(/\s+/g,"") + '</mark>' + " is the children of " + '<mark>' + questionTEM[0] + '</mark>' +" ?");

        //delete #1
        d3.select('#chart1').select("svg").remove();
        if(seq<seqTotal+1)//no movement in the end iteration
        {
            //move the #chart2 to left
            $("#chart2").fadeIn('slow',function(){
                $(this).animate({'left': '-=600px'},300,function(){
                        //#1 copy #2
                        document.getElementById("chart1").appendChild(
                            document.getElementById("chart2").querySelector("svg")
                        );
                        //move the #chart2back to right
                        $("#chart2").animate({
                            'left' : "0px" //moves right
                        });
                });
            });
        }
        //set progress bar
        var temSeq = seq-1;
        if(temSeq<seqTotal)
        {
            document.getElementById("slidesProgress").style.width= 100*temSeq/seqTotal+"%";
            $("#slidesProgress").html(Math.round(100*temSeq/seqTotal)+"%");  
        }    
        else if(temSeq==seqTotal)
        {
            document.getElementById("slidesProgress").style.width= 100+"%";
            $("#slidesProgress").html(100*temSeq/seqTotal+"%");  
            $("#slidesProgress").attr("class", "progress-bar progress-bar-danger progress-bar-striped");
            document.getElementById("restartBTN").style.visibility="visible";
            document.getElementById("answerYES").style.visibility="hidden";
            document.getElementById("answerNO").style.visibility="hidden";
            document.getElementById("next_question").style.visibility="hidden";
        }   
    }
    </script>
    <!-- set buttons -->
    <script type="text/javascript">
        //start scroll down button
        $("#startBTN").click(function() {
            $('html,body').animate({
                scrollTop: $("#vizSection").offset().top},
                'slow');
        });
        $("#galleryBTN").click(function() {
            $('html,body').animate({
                scrollTop: $("#gallerySection").offset().top},
                'slow');
        });
        $("#animationBTN").click(function() {
            $('html,body').animate({
                scrollTop: $("#animationSection").offset().top},
                'slow');
        });
        $('#galleryBTNBack').click(function() {
            $('html,body').animate({
                scrollTop: $("#vizSection").offset().top},
                'slow');
        });
        $('#animationBTNBack').click(function() {
            $('html,body').animate({
                scrollTop: $("#vizSection").offset().top},
                'slow');
        });
        
    </script>

</body>
</html>
